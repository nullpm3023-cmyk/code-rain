<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æ¥µç°¡é»‘é­‚è¨ˆåˆ†ç³»çµ± - å°ˆæ¥­å­˜è­‰ç‰ˆ</title>
    <style>
        :root {
            --primary: #007bff;
            --success: #28a745;
            --warning: #f39c12;
            --bg-dark: #000000;
            --panel-dark: #0a0a0a;
            --input-bg: #1a1a1a;
            --text-main: #ffffff;
            --text-dim: #888;
            --border-color: #333;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: "Microsoft JhengHei", sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* å·¦å´æ§åˆ¶é¢æ¿ */
        .left-panel {
            flex: 1;
            padding: 40px 50px;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        /* å³å´æ’åæ¸…å–® */
        .right-panel {
            flex: 1.2;
            padding: 40px 50px;
            background-color: var(--panel-dark);
            overflow-y: auto;
        }

        h2 { border-left: 5px solid var(--primary); padding-left: 15px; margin-bottom: 25px; font-size: 24px; }
        h3 { font-size: 14px; color: var(--text-dim); margin-bottom: 12px; font-weight: normal; letter-spacing: 1px; }

        .name-section { margin-bottom: 40px; }
        input#playerName {
            width: 100%;
            padding: 15px;
            background: var(--input-bg);
            border: 2px solid var(--border-color);
            color: #fff;
            border-radius: 8px;
            font-size: 20px;
            box-sizing: border-box;
        }
        input#playerName:focus { outline: none; border-color: var(--primary); background: #222; }

        .grid-3-cols {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .btn-score {
            background: #222;
            border: 1px solid #444;
            color: #fff;
            padding: 22px 5px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 22px;
            transition: all 0.2s;
        }
        .btn-score:hover { background: var(--primary); transform: translateY(-2px); }

        .settings-section {
            margin-top: auto;
            padding-top: 25px;
            border-top: 1px solid #222;
        }
        .config-input {
            background: #111;
            border: 1px solid #333;
            color: #fff;
            padding: 10px;
            text-align: center;
            border-radius: 6px;
            width: 100%;
            box-sizing: border-box;
        }

        .status-box {
            background: rgba(0, 123, 255, 0.1);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 4px solid var(--primary);
            display: none;
        }

        /* åŒ¯å‡ºæŒ‰éˆ•æ¨£å¼ */
        .export-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        .btn-export {
            background: #333;
            color: #ccc;
            border: 1px solid #444;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        .btn-export:hover { background: #444; color: #fff; }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: var(--text-dim); padding: 15px 10px; border-bottom: 2px solid #333; font-size: 14px; }
        td { padding: 18px 10px; border-bottom: 1px solid #111; font-size: 18px; }
        .rank-1 { color: #ffd700; font-size: 24px; font-weight: bold; }
        .reset-btn { background: none; border: none; color: #333; cursor: pointer; font-size: 12px; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="left-panel">
        <h2>è¨ˆåˆ†æ§åˆ¶å°</h2>

        <div id="lastStatus" class="status-box"></div>

        <div class="name-section">
            <h3>Step 1. æˆå“¡åç¨±</h3>
            <input type="text" id="playerName" placeholder="è«‹è¼¸å…¥å§“å" list="historyNames" autocomplete="off">
            <datalist id="historyNames"></datalist>
        </div>

        <div class="score-section">
            <h3>Step 2. é»é¸åˆ†æ•¸ (è‡ªå‹•é€å‡º)</h3>
            <div id="dynamicButtons" class="grid-3-cols"></div>
        </div>

        <div class="settings-section">
            <h3>âš™ï¸ æ•¸å€¼è¨­å®š / ç´€éŒ„åŒ¯å‡º</h3>
            <div id="configGrid" class="grid-3-cols">
                <input type="number" class="config-input" value="10" onchange="saveConfig()">
                <input type="number" class="config-input" value="20" onchange="saveConfig()">
                <input type="number" class="config-input" value="30" onchange="saveConfig()">
                <input type="number" class="config-input" value="50" onchange="saveConfig()">
                <input type="number" class="config-input" value="100" onchange="saveConfig()">
                <input type="number" class="config-input" value="-10" onchange="saveConfig()">
            </div>
            
            <div class="export-group">
                <button class="btn-export" onclick="exportHistory()">ğŸ’¾ åŒ¯å‡ºåŠ åˆ†æ˜ç´°</button>
                <button class="btn-export" onclick="exportRanking()">ğŸ“Š åŒ¯å‡ºæœ€çµ‚æ’å</button>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center;">
                <button class="reset-btn" onclick="resetData()">æ¸…ç©ºæ‰€æœ‰ç´€éŒ„</button>
                <span style="font-size: 11px; color: #333;">Data Auto-Saved</span>
            </div>
        </div>
    </div>

    <div class="right-panel">
        <h2>å³æ™‚æ’åæ¿</h2>
        <table>
            <thead>
                <tr>
                    <th width="20%">åæ¬¡</th>
                    <th width="55%">æˆå“¡å§“å</th>
                    <th width="25%">ç¸½åˆ†</th>
                </tr>
            </thead>
            <tbody id="rankDisplay"></tbody>
        </table>
    </div>

<script>
    let players = {};
    let actionLogs = []; // ç”¨æ–¼å­˜æ”¾æ¯ä¸€ç­†åŠ åˆ†ç´€éŒ„
    let buttonConfigs = [10, 20, 30, 50, 100, -10];

    window.onload = function() {
        const savedConfig = localStorage.getItem('score_cfg_v4');
        if (savedConfig) {
            buttonConfigs = JSON.parse(savedConfig);
            const inputs = document.querySelectorAll('.config-input');
            buttonConfigs.forEach((val, i) => { if(inputs[i]) inputs[i].value = val; });
        }
        renderButtons();
    };

    function saveConfig() {
        const inputs = document.querySelectorAll('.config-input');
        buttonConfigs = Array.from(inputs).map(input => parseInt(input.value) || 0);
        localStorage.setItem('score_cfg_v4', JSON.stringify(buttonConfigs));
        renderButtons();
    }

    function renderButtons() {
        const container = document.getElementById('dynamicButtons');
        container.innerHTML = "";
        buttonConfigs.forEach(val => {
            const btn = document.createElement('button');
            btn.className = 'btn-score';
            btn.innerText = (val > 0 ? '+' : '') + val;
            btn.onclick = () => submitScore(val);
            container.appendChild(btn);
        });
    }

    function submitScore(scoreValue) {
        const nameInput = document.getElementById('playerName');
        const name = nameInput.value.trim();

        if (!name) {
            alert("è«‹å…ˆè¼¸å…¥åç¨±");
            nameInput.focus();
            return;
        }

        players[name] = (players[name] || 0) + scoreValue;

        // å­˜å…¥ç´€éŒ„æ˜ç´°
        const now = new Date();
        const timeStr = `${now.getHours()}:${now.getMinutes()}:${now.getSeconds()}`;
        actionLogs.push({
            time: timeStr,
            name: name,
            change: scoreValue,
            total: players[name]
        });

        updateUI(name, scoreValue);
        nameInput.value = "";
        nameInput.focus();
    }

    function updateUI(lastUser, lastScore) {
        const sorted = Object.keys(players)
            .map(n => ({ name: n, score: players[n] }))
            .sort((a, b) => b.score - a.score);

        const tbody = document.getElementById('rankDisplay');
        tbody.innerHTML = "";
        
        let lastRank = 0;
        sorted.forEach((p, i) => {
            const rank = i + 1;
            if (p.name === lastUser) lastRank = rank;
            let rc = rank === 1 ? "rank-1" : (rank <= 3 ? "rank-2" : "");
            tbody.innerHTML += `<tr><td class="${rc}">${rank}</td><td>${p.name}</td><td><strong>${p.score}</strong></td></tr>`;
        });

        const status = document.getElementById('lastStatus');
        status.style.display = "block";
        status.innerHTML = `<strong>${lastUser}</strong> ç²å¾— ${lastScore} åˆ† | ç›®å‰æ’åç¬¬ ${lastRank}`;

        const dl = document.getElementById('historyNames');
        dl.innerHTML = "";
        Object.keys(players).forEach(n => dl.innerHTML += `<option value="${n}">`);
    }

    // --- åŒ¯å‡ºåŠŸèƒ½ ---

    function downloadCSV(csvContent, fileName) {
        // åŠ å…¥ BOM (UTF-8) è®“ Excel èªå¾—ä¸­æ–‡
        const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function exportHistory() {
        if (actionLogs.length === 0) return alert("å°šç„¡ç´€éŒ„å¯åŒ¯å‡º");
        let csv = "æ™‚é–“,æˆå“¡å§“å,è®Šå‹•åˆ†æ•¸,è®Šå‹•å¾Œç¸½åˆ†\n";
        actionLogs.forEach(row => {
            csv += `${row.time},${row.name},${row.change},${row.total}\n`;
        });
        downloadCSV(csv, "è¨ˆåˆ†è©³ç´°ç´€éŒ„.csv");
    }

    function exportRanking() {
        const sorted = Object.keys(players)
            .map(n => ({ name: n, score: players[n] }))
            .sort((a, b) => b.score - a.score);
        
        if (sorted.length === 0) return alert("ç›®å‰å°šç„¡æ’åè³‡æ–™");
        let csv = "åæ¬¡,æˆå“¡å§“å,æœ€çµ‚ç¸½åˆ†\n";
        sorted.forEach((p, i) => {
            csv += `${i + 1},${p.name},${p.score}\n`;
        });
        downloadCSV(csv, "æœ€çµ‚æ’åè¡¨.csv");
    }

    function resetData() {
        if(confirm("ç¢ºå®šæ¸…ç©ºç´€éŒ„å—ï¼Ÿé€™å°‡åˆªé™¤ç›®å‰çš„æ’åèˆ‡æµæ°´å¸³ç´€éŒ„ï¼")) {
            players = {};
            actionLogs = [];
            document.getElementById('rankDisplay').innerHTML = "";
            document.getElementById('lastStatus').style.display = "none";
        }
    }
</script>
</body>
</html>
